#! /usr/bin/env ruby

require 'mechanize'

LGTM_LINK_BASE = 'http://lgtm.in/i'.freeze
LGTM_HAITO_PAGE = ENV['LGTM_IN_USER_PATH']

REFLASH_TIME = 604_800.freeze

LAST_EXECUTED_AT_TIME_PATH = 'last_executed_at.time'.freeze
CACHED_LINKS_PATH = 'cached_links.links'.freeze
BASE_PATH = File.expand_path('..', __FILE__)

LGTM_MARKDOWN = '[![LGTM](__LGTM_IMAGE_DETAILS_PATH__)](__LGTM_IMAGE_PATH__)'
LGTM_MARKDOWN_DETAIL_PATH_BASE = 'http://lgtm.in/p/'.freeze
LGTM_MARKDOWN_IMAGE_PATH_BASE = 'http://lgtm.in/i/'.freeze

last_executed_at = begin File.read(BASE_PATH + '/' + LAST_EXECUTED_AT_TIME_PATH); rescue; nil;
                   end

cached_links = begin File.read(BASE_PATH + '/' + CACHED_LINKS_PATH); rescue; nil
               end

def fetch_links
  agent = Mechanize.new
  page = agent.get(LGTM_HAITO_PAGE)
  page.links.map(&:href).select {|link| link.match(LGTM_LINK_BASE) }
end

def update_executed_at!
  File.open(BASE_PATH + '/' + LAST_EXECUTED_AT_TIME_PATH, 'w') {|f| f.write(Time.now.to_i) }
end

def cache_links!(links)
  File.open(BASE_PATH + '/' + CACHED_LINKS_PATH, 'w') {|f| f.write(Marshal.dump(links)) }
end

links =
  if Time.now.to_i - last_executed_at.to_i > REFLASH_TIME
    update_executed_at!

    links = fetch_links
    cache_links!(links)

    links
  else
    cached_links.nil? ? fetch_links : Marshal.load(cached_links)
  end

link = links.sample

hash = link.split('/').last

lgtm_markdown = LGTM_MARKDOWN.gsub('__LGTM_IMAGE_DETAILS_PATH__', "#{LGTM_MARKDOWN_DETAIL_PATH_BASE + hash}").gsub('__LGTM_IMAGE_PATH__', "#{LGTM_MARKDOWN_IMAGE_PATH_BASE + hash}")

system("echo '#{lgtm_markdown}' | pbcopy")

